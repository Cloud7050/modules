(function () {
    'use strict';

    var _WIDTH=400;var _HEIGHT=300;var _video;var _canvas;var _context;var _errorLogger;var _pixels=[];var _temp=[];var _filter=copy_image;var _isPlaying=false;var _FPS=10;var _startTime;function init(){return function(video,canvas,errorLogger){_video=video;_canvas=canvas;_errorLogger=errorLogger;var context=_canvas.getContext("2d");if(context==null)throw new Error("Canvas context should not be null.");_context=context;setupData();loadMedia();}}function video_height(){return _HEIGHT}function video_width(){return _WIDTH}function copy_image(src,dest){for(var i=0;i<_HEIGHT;i++){for(var j=0;j<_WIDTH;j++){dest[i][j]=src[i][j];}}}function install_filter(filter){_filter=filter;}function index(){return {init:init,install_filter:install_filter,copy_image:copy_image,video_height:video_height,video_width:video_width}}function setupData(){for(var i=0;i<_WIDTH;i++){_pixels[i]=[];_temp[i]=[];}}function loadMedia(){if(!navigator.mediaDevices.getUserMedia){var errMsg="The browser you are using does not support getUserMedia";console.error(errMsg);_errorLogger(errMsg,false);}if(_video.srcObject!=null)return;navigator.mediaDevices.getUserMedia({video:true}).then(function(stream){_video.srcObject=stream;}).catch(function(error){var errorMessage=error.name+": "+error.message;console.error(errorMessage);_errorLogger(errorMessage,false);});startVideo();}function startVideo(){if(_isPlaying)return;_isPlaying=true;window.requestAnimationFrame(draw);}function draw(timestamp){window.requestAnimationFrame(draw);if(_startTime==null)_startTime=timestamp;var elapsed=timestamp-_startTime;if(elapsed>1000/_FPS){drawFrame();_startTime=timestamp;}}function drawFrame(){_context.drawImage(_video,0,0,_WIDTH,_HEIGHT);var pixelObj=_context.getImageData(0,0,_WIDTH,_HEIGHT);readFromBuffer(pixelObj.data,_pixels);try{_filter(_pixels,_temp);writeToBuffer(pixelObj.data,_temp);}catch(e){console.error(JSON.stringify(e));var errMsg="There is an error with filter function, filter will be reset to default. "+e.name+": "+e.message;console.error(errMsg);if(!e.name){_errorLogger("There is an error with filter function (error shown below). Filter will be reset back to the default. If you are facing an infinite loop error, you can consider increasing the timeout period (clock icon) at the top / reducing the video dimensions.");_errorLogger([e],true);}else {_errorLogger(errMsg,false);}_filter=copy_image;_filter(_pixels,_temp);}_context.putImageData(pixelObj,0,0);}function readFromBuffer(pixelData,src){for(var i=0;i<_HEIGHT;i++){for(var j=0;j<_WIDTH;j++){var p=i*_WIDTH*4+j*4;src[i][j]=[pixelData[p],pixelData[p+1],pixelData[p+2],pixelData[p+3]];}}}function writeToBuffer(buffer,data){var ok=true;for(var i=0;i<_HEIGHT;i++){for(var j=0;j<_WIDTH;j++){var p=i*_WIDTH*4+j*4;if(isPixelFilled(data[i][j])===false){ok=false;}buffer[p]=data[i][j][0];buffer[p+1]=data[i][j][1];buffer[p+2]=data[i][j][2];buffer[p+3]=data[i][j][3];}}if(!ok){var warningMessage="You have invalid values for some pixels! Reseting them to default (0)";console.warn(warningMessage);_errorLogger(warningMessage,false);}}function isPixelFilled(pixel){var ok=true;for(var i=0;i<4;i++){if(pixel[i]>=0&&pixel[i]<=255){continue}ok=false;pixel[i]=0;}return ok}

    return index;

}());
